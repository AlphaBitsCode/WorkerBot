/* Copyright (C) 2023 by WorkerBot.AI */
!function(t){function e(e){return t(e).data("treegrid")?"treegrid":"datagrid"}var r=t.fn.datagrid.methods.autoSizeColumn,i=t.fn.datagrid.methods.loadData,a=t.fn.datagrid.methods.appendRow,n=t.fn.datagrid.methods.insertRow,o=t.fn.datagrid.methods.deleteRow;t.extend(t.fn.datagrid.methods,{clientPaging:function(e){return e.each((function(){var e=t(this),r=e.data("datagrid"),i=r.options;i.loadFilter=S;var a=i.onBeforeLoad;i.onBeforeLoad=function(t){return r.allRows=null,a.call(this,t)};var n=e.datagrid("getPager");n.pagination({onSelectPage:function(t,a){i.pageNumber=t,i.pageSize=a,n.pagination("refresh",{pageNumber:t,pageSize:a}),e.datagrid("loadData",r.allRows)}}),t(this).datagrid("loadData",r.data),i.url&&t(this).datagrid("reload")}))},autoSizeColumn:function(e,i){return e.each((function(){var e=t(this).datagrid("getPanel").find(".datagrid-header .datagrid-filter-c");e.css({width:"1px",height:0}),r.call(t.fn.datagrid.methods,t(this),i),e.css({width:"",height:""}),c(this,i)}))},loadData:function(e,r){return e.each((function(){t.data(this,"datagrid").filterSource=null,t(this).data("datagrid").allRows=r.rows?r.rows:r})),i.call(t.fn.datagrid.methods,e,r)},appendRow:function(e,r){var i=a.call(t.fn.datagrid.methods,e,r);return e.each((function(){var e=t(this).data("datagrid");e.filterSource&&(e.filterSource.total++,e.filterSource.rows!=e.data.rows&&e.filterSource.rows.push(r))})),i},insertRow:function(e,r){var i=n.call(t.fn.datagrid.methods,e,r);return e.each((function(){var e=t(this).data("datagrid");if(e.filterSource&&(e.filterSource.total++,e.filterSource.rows!=e.data.rows)){var i=r.index||0;i>e.filterSource.rows.length&&(i=e.filterSource.rows.length),e.filterSource.rows.splice(i,0,r.row)}})),i},deleteRow:function(e,r){return e.each((function(){var e=t(this).datagrid("getRows")[r];o.call(t.fn.datagrid.methods,t(this),r);var i=t(this).data("datagrid");if(i.allRows){for(var a=0;a<i.allRows.length;a++)if(i.allRows[a]==e){i.allRows.splice(a,1);break}t(this).datagrid("loadData",i.allRows)}}))},getAllRows:function(t){return t.data("datagrid").allRows}});var l=t.fn.treegrid.methods.loadData,d=t.fn.treegrid.methods.append,f=t.fn.treegrid.methods.insert,s=t.fn.treegrid.methods.remove;t.extend(t.fn.treegrid.methods,{loadData:function(e,r){return e.each((function(){t.data(this,"treegrid").filterSource=null})),l.call(t.fn.treegrid.methods,e,r)},append:function(e,r){return e.each((function(){var e=t(this).data("treegrid");if(e.options.oldLoadFilter){var i=m(this,r.data,r.parent);e.filterSource.total+=i.length,e.filterSource.rows=e.filterSource.rows.concat(i),t(this).treegrid("loadData",e.filterSource)}else d(t(this),r)}))},insert:function(e,r){return e.each((function(){var e=t(this).data("treegrid"),i=e.options;if(i.oldLoadFilter){r.before||r.after;var a=function(t){for(var r=e.filterSource.rows,a=0;a<r.length;a++)if(r[a][i.idField]==t)return a;return-1}(r.before||r.after),n=a>=0?e.filterSource.rows[a]._parentId:null,o=m(this,[r.data],n),l=e.filterSource.rows.splice(0,a>=0?r.before?a:a+1:e.filterSource.rows.length);l=(l=l.concat(o)).concat(e.filterSource.rows),e.filterSource.total+=o.length,e.filterSource.rows=l,t(this).treegrid("loadData",e.filterSource)}else f(t(this),r)}))},remove:function(e,r){return e.each((function(){var e=t(this).data("treegrid");if(e.filterSource)for(var i=e.options,a=e.filterSource.rows,n=0;n<a.length;n++)if(a[n][i.idField]==r){a.splice(n,1),e.filterSource.total--;break}})),s(e,r)}});var u={filterMenuIconCls:"icon-ok",filterBtnIconCls:"icon-filter",filterBtnPosition:"right",filterPosition:"bottom",remoteFilter:!1,clientPaging:!0,showFilterBar:!0,filterDelay:400,filterRules:[],filterMatchingType:"all",filterIncludingChild:!1,filterMatcher:function(r){var i=e(this),a=t(this),n=t.data(this,i).options;if(n.filterRules.length){var o=[];if("treegrid"==i){var l={};for(var d in t.map(r.rows,(function(e){if(c(e,e[n.idField])){l[e[n.idField]]=e;for(var i=h(r.rows,e._parentId);i;)l[i[n.idField]]=i,i=h(r.rows,i._parentId);if(n.filterIncludingChild){var a=function(e,r){var i=g(e,r),a=t.extend(!0,[],i);for(;a.length;){var o=g(e,a.shift()[n.idField]);i=i.concat(o),a=a.concat(o)}return i}(r.rows,e[n.idField]);t.map(a,(function(t){l[t[n.idField]]=t}))}}})),l)o.push(l[d])}else for(var f=0;f<r.rows.length;f++){var s=r.rows[f];c(s,f)&&o.push(s)}r={total:r.total-(r.rows.length-o.length),rows:o}}return r;function c(e,r){n.val==t.fn.combogrid.defaults.val&&(n.val=u.val);var i=n.filterRules;if(!i.length)return!0;for(var o=0;o<i.length;o++){var l=i[o],d=a.datagrid("getColumnOption",l.field),f=d&&d.formatter?d.formatter(e[l.field],e,r):void 0,s=n.val.call(a[0],e,l.field,f);null==s&&(s="");var c=n.operators[l.op].isMatch(s,l.value);if("any"==n.filterMatchingType){if(c)return!0}else if(!c)return!1}return"all"==n.filterMatchingType}function h(t,e){for(var r=0;r<t.length;r++){var i=t[r];if(i[n.idField]==e)return i}return null}function g(t,e){for(var r=[],i=0;i<t.length;i++){var a=t[i];a._parentId==e&&r.push(a)}return r}},defaultFilterType:"text",defaultFilterOperator:"contains",defaultFilterTrigger:"keydown",defaultFilterOptions:{onInit:function(r){var i=e(r),a=t(r)[i]("options"),n=this.filterOptions,o=t(this).attr("name"),l=t(this);l.data("textbox")&&(l=l.textbox("textbox"));var d=n.trigger||a.defaultFilterTrigger;function f(){var e=t(r)[i]("getFilterRule",o),d=l.val();if(n.options.prompt&&n.options.prompt==d&&(d=""),""!=d){if(e&&e.value!=d||!e){var f=e?e.op:n&&n.defaultFilterOperator||a.defaultFilterOperator;t(r)[i]("addFilterRule",{field:o,op:f,value:d}),t(r)[i]("doFilter")}}else e&&(t(r)[i]("removeFilterRule",o),t(r)[i]("doFilter"))}l.off(".filter").on(d+".filter",(function(e){t(this);this.timer&&clearTimeout(this.timer),13==e.keyCode?f():a.filterDelay&&(this.timer=setTimeout((function(){f()}),a.filterDelay))}))}},filterStringify:function(t){return JSON.stringify(t)},val:function(t,e,r){return r||t[e]},onClickMenu:function(t,e){}};function c(e,r){var i=!1,a=t(e),n=a.datagrid("getPanel").find("div.datagrid-header"),o=n.find(".datagrid-header-row:not(.datagrid-filter-row)");(r?n.find('.datagrid-filter[name="'+r+'"]'):n.find(".datagrid-filter")).each((function(){var e=t(this).attr("name"),r=a.datagrid("getColumnOption",e),n=t(this).closest("div.datagrid-filter-c"),l=n.find("a.datagrid-filter-btn"),d=o.find('td[field="'+e+'"] .datagrid-cell')._outerWidth();d!=function(e){var r=0;return t(e).children(":visible").each((function(){r+=t(this)._outerWidth()})),r}(n)&&this.filter.resize(this,d-l._outerWidth()),n.width()>r.boxWidth+r.deltaWidth-1&&(r.boxWidth=n.width()-r.deltaWidth+1,r.width=r.boxWidth+r.deltaWidth,i=!0)})),i&&t(e).datagrid("fixColumnSize")}function h(e,r){return t(e).datagrid("getPanel").find("div.datagrid-header").find('tr.datagrid-filter-row td[field="'+r+'"] .datagrid-filter')}function g(r,i){for(var a=e(r),n=t(r)[a]("options").filterRules,o=0;o<n.length;o++)if(n[o].field==i)return o;return-1}function p(r,i){var a=e(r),n=t(r)[a]("options"),o=n.filterRules;if("nofilter"==i.op)v(r,i.field);else{var l=g(r,i.field);l>=0?t.extend(o[l],i):o.push(i)}var d=h(r,i.field);if(d.length){if("nofilter"!=i.op){var f=d.val();d.data("textbox")&&(f=d.textbox("getText")),f!=i.value&&d[0].filter.setValue(d,i.value)}var s=d[0].menu;if(s){s.find("."+n.filterMenuIconCls).removeClass(n.filterMenuIconCls);var u=s.menu("findItem",n.operators[i.op].text);s.menu("setIcon",{target:u.target,iconCls:n.filterMenuIconCls})}}}function v(r,i){var a=e(r),n=t(r),o=n[a]("options");if(i){var l=g(r,i);l>=0&&o.filterRules.splice(l,1),d([i])}else{o.filterRules=[],d(n.datagrid("getColumnFields",!0).concat(n.datagrid("getColumnFields")))}function d(t){for(var e=0;e<t.length;e++){var i=h(r,t[e]);if(i.length){i[0].filter.setValue(i,"");var a=i[0].menu;a&&a.find("."+o.filterMenuIconCls).removeClass(o.filterMenuIconCls)}}}}function w(r){var i=e(r),a=t.data(r,i),n=a.options;n.remoteFilter?t(r)[i]("load"):("scrollview"==n.view.type&&a.data.firstRows&&a.data.firstRows.length&&(a.data.rows=a.data.firstRows),t(r)[i]("getPager").pagination("refresh",{pageNumber:1}),t(r)[i]("options").pageNumber=1,t(r)[i]("loadData",a.filterSource||a.data))}function m(e,r,i){var a=t(e).treegrid("options");if(!r||!r.length)return[];var n=[];return t.map(r,(function(t){t._parentId=i,n.push(t),n=n.concat(m(e,t.children,t[a.idField]))})),t.map(n,(function(t){delete t.children})),n}function S(r,i){var a=this,n=e(a),o=t.data(a,n),l=o.options;if(o.allRows||(o.allRows=r.rows),"datagrid"==n&&t.isArray(r))r={total:r.length,rows:r};else if("treegrid"==n&&t.isArray(r)){var d=m(a,r,i);r={total:d.length,rows:d}}if(!l.remoteFilter||l.clientPaging){if(o.filterSource){if(l.isSorting)l.isSorting=void 0;else if("datagrid"==n)o.filterSource=r;else if(o.filterSource.total+=r.length,o.filterSource.rows=o.filterSource.rows.concat(r.rows),i)return l.filterMatcher.call(a,r)}else o.filterSource=r;if(!l.remoteSort&&l.sortName){var f=l.sortName.split(","),s=l.sortOrder.split(","),u=t(a);o.filterSource.rows.sort((function(t,e){for(var r=0,i=0;i<f.length;i++){var a=f[i],n=s[i];if(0!=(r=(u.datagrid("getColumnOption",a).sorter||function(t,e){return t==e?0:t>e?1:-1})(t[a],e[a])*("asc"==n?1:-1)))return r}return r}))}(r=l.filterMatcher.call(a,{total:o.filterSource.total,rows:o.filterSource.rows,footer:o.filterSource.footer||[]})).filterRows=r.rows}if(l.pagination&&l.clientPaging){var c=(u=t(a))[n]("getPager");if(c.pagination({onSelectPage:function(t,e){l.pageNumber=t,l.pageSize=e,c.pagination("refresh",{pageNumber:t,pageSize:e}),l.clientPaging?u[n]("loadData",o.filterSource):u[n]("reload")},onBeforeRefresh:function(){return u[n]("reload"),!1}}),"datagrid"==n){var h=v(r.rows);l.pageNumber=h.pageNumber,r.rows=h.rows}else{var g=[],p=[];t.map(r.rows,(function(t){t._parentId?p.push(t):g.push(t)})),r.total=g.length;h=v(g);l.pageNumber=h.pageNumber,r.rows=h.rows.concat(p)}}return t.map(r.rows,(function(t){delete t.children})),r;function v(t){for(var e=[],r=l.pageNumber;r>0;){var i=(r-1)*parseInt(l.pageSize),a=i+parseInt(l.pageSize);if((e=t.slice(i,a)).length)break;r--}return{pageNumber:r>0?r:1,rows:e}}}t.extend(t.fn.datagrid.defaults,u),t.extend(t.fn.treegrid.defaults,u),t.fn.datagrid.defaults.filters=t.extend({},t.fn.datagrid.defaults.editors,{label:{init:function(e,r){return t("<span></span>").appendTo(e)},getValue:function(e){return t(e).html()},setValue:function(e,r){t(e).html(r)},resize:function(e,r){t(e)._outerWidth(r)._outerHeight(22)}}}),t.fn.treegrid.defaults.filters=t.fn.datagrid.defaults.filters,t.fn.datagrid.defaults.operators={nofilter:{text:"No Filter"},contains:{text:"Contains",isMatch:function(t,e){return t=String(t),e=String(e),t.toLowerCase().indexOf(e.toLowerCase())>=0}},equal:{text:"Equal",isMatch:function(t,e){return t==e}},notequal:{text:"Not Equal",isMatch:function(t,e){return t!=e}},beginwith:{text:"Begin With",isMatch:function(t,e){return t=String(t),e=String(e),0==t.toLowerCase().indexOf(e.toLowerCase())}},endwith:{text:"End With",isMatch:function(t,e){return t=String(t),e=String(e),-1!==t.toLowerCase().indexOf(e.toLowerCase(),t.length-e.length)}},less:{text:"Less",isMatch:function(t,e){return t<e}},lessorequal:{text:"Less Or Equal",isMatch:function(t,e){return t<=e}},greater:{text:"Greater",isMatch:function(t,e){return t>e}},greaterorequal:{text:"Greater Or Equal",isMatch:function(t,e){return t>=e}}},t.fn.treegrid.defaults.operators=t.fn.datagrid.defaults.operators,t.extend(t.fn.datagrid.methods,{isFilterEnabled:function(r){var i=e(r[0]);return!!t.data(r[0],i).options.oldLoadFilter},enableFilter:function(r,i){return r.each((function(){var r=e(this),a=t.data(this,r).options;if(a.oldLoadFilter){if(!i)return;t(this)[r]("disableFilter")}a.oldLoadFilter=a.loadFilter,function(r,i){i=i||[];var a=e(r),n=t.data(r,a),o=n.options;o.filterRules.length||(o.filterRules=[]),o.filterCache=o.filterCache||{};var l=t.data(r,"datagrid").options,d=l.onResize;l.onResize=function(t,e){c(r),d.call(this,t,e)};var f=l.onBeforeSortColumn;l.onBeforeSortColumn=function(t,e){var r=f.call(this,t,e);return 0!=r&&(o.isSorting=!0),r};var s=o.onResizeColumn;o.onResizeColumn=function(e,i){var a=t(this).datagrid("getPanel").find(".datagrid-header .datagrid-filter-c"),n=a.find(".datagrid-filter:focus");a.css({width:"1px",height:0}),t(r).datagrid("fitColumns"),o.fitColumns?c(r):c(r,e),a.css({width:"",height:""}),n.blur().focus(),s.call(r,e,i)};var u=o.onBeforeLoad;if(o.onBeforeLoad=function(t,e){t&&(t.filterRules=o.filterStringify(o.filterRules)),e&&(e.filterRules=o.filterStringify(o.filterRules));var r=u.call(this,t,e);if(0!=r&&o.url)if("datagrid"==a)n.filterSource=null;else if("treegrid"==a&&n.filterSource)if(t){for(var i=t[o.idField],l=n.filterSource.rows||[],d=0;d<l.length;d++)if(i==l[d]._parentId)return!1}else n.filterSource=null;return r},("detailview"==o.view.type||"scrollview"==o.view.type)&&o.frozenColumns&&o.frozenColumns.length){var h=o.view.onBeforeRender;o.view.onBeforeRender=function(e){if(h.call(o.view,e),!o.detailviewFilterInited){o.detailviewFilterInited=!0;var r=t(e).datagrid("getColumnFields",!0);o.rownumbers&&r.unshift("_");var i=t(e).data("datagrid").dc.header1.find(".datagrid-filter-row");if(i.length<r.length){var a=t.inArray("_expander",r);if(a>=0){var n=i.children().eq(a);n.length?t('<td class="_expander"></td>').insertBefore(n):t('<td class="_expander"></td>').appendTo(i)}}}}}function g(e){var i=n.dc,l=t(r).datagrid("getColumnFields",e);e&&o.rownumbers&&l.unshift("_");var d=(e?i.header1:i.header2).find("table.datagrid-htable");d.find(".datagrid-filter").each((function(){this.filter.destroy&&this.filter.destroy(this),this.menu&&t(this.menu).menu("destroy")})),d.find("tr.datagrid-filter-row").remove();var f=t('<tr class="datagrid-header-row datagrid-filter-row"></tr>');"bottom"==o.filterPosition?f.appendTo(d.find("tbody")):f.prependTo(d.find("tbody")),o.showFilterBar||f.hide();for(var s=0;s<l.length;s++){var u=l[s],h=t(r).datagrid("getColumnOption",u),g=t("<td></td>").attr("field",u).appendTo(f);if(h&&h.hidden&&g.hide(),"_"!=u&&(!h||!h.checkbox&&!h.expander)){var p=m(u);p?t(r)[a]("destroyFilter",u):p=t.extend({},{field:u,type:o.defaultFilterType,options:o.defaultFilterOptions});var w=o.filterCache[u];if(w)w.appendTo(g);else{w=t('<div class="datagrid-filter-c"></div>').appendTo(g);var S=o.filters[p.type],F=S.init(w,t.extend({height:o.editorHeight},p.options||{}));F.addClass("datagrid-filter").attr("name",u),F[0].filter=S,F[0].filterOptions=p,F[0].menu=v(w,p.op),p.op&&p.op.length?p.options&&p.options.onInit?p.options.onInit.call(F[0],r):p.defaultFilterOperator&&o.defaultFilterOptions.onInit.call(F[0],r):o.defaultFilterOptions.onInit.call(F[0],r),o.filterCache[u]=w,c(r,u)}}}}function v(e,i){if(!i)return null;var a=t('<a class="datagrid-filter-btn">&nbsp;</a>').addClass(o.filterBtnIconCls);a.css("height",o.editorHeight),"right"==o.filterBtnPosition?a.appendTo(e):a.prependTo(e);var n=t("<div></div>").appendTo("body");return t.map(["nofilter"].concat(i),(function(e){var r=o.operators[e];r&&t("<div></div>").attr("name",e).html(r.text).appendTo(n)})),n.menu({alignTo:a,onClick:function(e){var i=t(this).menu("options").alignTo,a=i.closest("td[field]"),n=a.attr("field"),l=a.find(".datagrid-filter"),d=l[0].filter.getValue(l);0!=o.onClickMenu.call(r,e,i,n)&&(p(r,{field:n,op:e.name,value:d}),w(r))}}),a[0].menu=n,a.on("click",{menu:n},(function(e){return t(this.menu).menu("show"),!1})),n}function m(t){for(var e=0;e<i.length;e++){var r=i[e];if(r.field==t)return r}return null}o.loadFilter=function(t,e){var r=o.oldLoadFilter.call(this,t,e);return S.call(this,r,e)},n.dc.view2.children(".datagrid-header").off(".filter").on("focusin.filter",(function(e){var r=t(this);setTimeout((function(){n.dc.body2._scrollLeft(r._scrollLeft())}),0)})).on("keydown.filter",(function(t){t.stopPropagation()})).on("keypress.filter",(function(t){t.stopPropagation()})),n.dc.view1.children(".datagrid-header").off(".filter").on("keydown.filter",(function(t){t.stopPropagation()})).on("keypress.filter",(function(t){t.stopPropagation()})),t("#datagrid-filter-style").length||t("head").append('<style id="datagrid-filter-style">a.datagrid-filter-btn{display:inline-block;width:22px;height:100%;margin:0;vertical-align:middle;cursor:pointer;opacity:0.6;filter:alpha(opacity=60);}a:hover.datagrid-filter-btn{opacity:1;filter:alpha(opacity=100);}.datagrid-filter-row .textbox,.datagrid-filter-row .textbox .textbox-text{-moz-border-radius:0;-webkit-border-radius:0;border-radius:0;}.datagrid-filter-row input{margin:0;-moz-border-radius:0;-webkit-border-radius:0;border-radius:0;}.datagrid-filter-c{overflow:hidden}.datagrid-filter-cache{position:absolute;width:10px;height:10px;left:-99999px;}</style>'),g(!0),g(),o.fitColumns&&setTimeout((function(){c(r)}),0),t.map(o.filterRules,(function(t){p(r,t)}))}(this,i),t(this)[r]("resize"),a.filterRules.length&&(a.remoteFilter||a.data)&&w(this)}))},disableFilter:function(r){return r.each((function(){var r=e(this),i=t.data(this,r),a=i.options;if(a.oldLoadFilter){var n=t(this).data("datagrid").dc,o=n.view.children(".datagrid-filter-cache");for(var l in o.length||(o=t('<div class="datagrid-filter-cache"></div>').appendTo(n.view)),a.filterCache)t(a.filterCache[l]).appendTo(o);var d=i.data;i.filterSource&&(d=i.filterSource,t.map(d.rows,(function(t){delete t.children}))),n.header1.add(n.header2).find("tr.datagrid-filter-row").remove(),a.loadFilter=a.oldLoadFilter||void 0,a.oldLoadFilter=null,t(this)[r]("resize"),t(this)[r]("loadData",d)}}))},destroyFilter:function(r,i){return r.each((function(){var r=e(this),a=t.data(this,r).options;if(i)o(i);else{for(var n in a.filterCache)o(n);t(this).datagrid("getPanel").find(".datagrid-header .datagrid-filter-row").remove(),t(this).data("datagrid").dc.view.children(".datagrid-filter-cache").remove(),a.filterCache={},t(this)[r]("resize"),t(this)[r]("disableFilter")}function o(e){var r=t(a.filterCache[e]),i=r.find(".datagrid-filter");if(i.length){var n=i[0].filter;n.destroy&&n.destroy(i[0])}r.find(".datagrid-filter-btn").each((function(){t(this.menu).menu("destroy")})),r.remove(),a.filterCache[e]=void 0}}))},getFilterRule:function(r,i){return function(r,i){var a=e(r),n=t(r)[a]("options").filterRules,o=g(r,i);return o>=0?n[o]:null}(r[0],i)},addFilterRule:function(t,e){return t.each((function(){p(this,e)}))},removeFilterRule:function(t,e){return t.each((function(){v(this,e)}))},doFilter:function(t){return t.each((function(){w(this)}))},getFilterComponent:function(t,e){return h(t[0],e)},resizeFilter:function(t,e){return t.each((function(){c(this,e)}))}})}(jQuery);