/* Copyright (C) 2023 by WorkerBot.AI */
!function(t){t.extend(t.fn.datagrid.defaults,{dropAccept:"tr.datagrid-row",dragSelection:!1,dragDelay:100,onBeforeDrag:function(t){},onStartDrag:function(t){},onStopDrag:function(t){},onDragEnter:function(t,a){},onDragOver:function(t,a){},onDragLeave:function(t,a){},onBeforeDrop:function(t,a,e){},onDrop:function(t,a,e){}}),t.extend(t.fn.datagrid.methods,{_appendRows:function(a,e){return a.each((function(){var a=t(this),r=t.isArray(e)?e:[e];t.map(r,(function(t){a.datagrid("appendRow",t).datagrid("enableDnd",a.datagrid("getRows").length-1)}))}))},_insertRows:function(a,e){return a.each((function(){var a=t(this),r=e.index,n=e.row,d=t.isArray(n)?n:[n];t.map(d,(function(t,e){a.datagrid("insertRow",{index:r+e,row:t}).datagrid("enableDnd",r+e)}))}))},_getRowIndexs:function(a,e){var r=a,n=t.isArray(e)?e:[e],d=t.map(n,(function(t){return r.datagrid("getRowIndex",t)}));return t.grep(d,(function(t){if(t>=0)return!0}))},_deleteRows:function(a,e){return a.each((function(){e.sort((function(t,a){return parseInt(t)>parseInt(a)?-1:1}));for(var a=0;a<e.length;a++)t(this).datagrid("deleteRow",e[a])}))},_setSelections:function(a){return a.each((function(){for(var a=t(this).datagrid("getRows"),e=0;e<a.length;e++)a[e]._selected&&(t(this).datagrid("selectRow",e),a[e]._selected=void 0)}))},clearInsertingFlag:function(a){return a.each((function(){var a=t(this).datagrid("options");a.insertingIndex>=0&&(a.finder.getTr(this,a.insertingIndex).removeClass("datagrid-row-top datagrid-row-bottom"),a.insertingIndex=-1)}))}});var a=[];function e(a){t.map(a,(function(a){t(a).droppable("enable")}))}t.extend(t.fn.datagrid.methods,{resetDroppable:function(r){return r.each((function(){for(var r=t(this).datagrid("getPanel")[0],n=[],d=[],i=0;i<a.length;i++){var o=a[i],s=t(o).closest("div.datagrid-wrap");s.length&&s[0]==r?n.push(o):d.push(o)}a=d,e(n)}))},enableDnd:function(r,n){return t("#datagrid-dnd-style").length||t('<style id="datagrid-dnd-style">.datagrid-row-top>td{border-top:1px solid red}.datagrid-row-bottom>td{border-bottom:1px solid red}</style>').appendTo("head"),r.each((function(){var r=this,d=t.data(this,"datagrid"),i=t(this),o=d.options,s={disabled:!1,revert:!0,cursor:"pointer",proxy:function(a){var e=t('<div style="z-index:9999999999999"></div>').appendTo("body"),n=c(a),d=t.isArray(n)?n:[n];return t.map(d,(function(a,n){var d=i.datagrid("getRowIndex",a),s=o.finder.getTr(r,d,"body",1);o.finder.getTr(r,d,"body",2).clone().removeAttr("id").removeClass("droppable").appendTo(e),s.clone().removeAttr("id").removeClass("droppable").find("td").insertBefore(e.find("tr:eq("+n+") td:first")),t('<td><span class="tree-dnd-icon tree-dnd-no" style="position:static">&nbsp;</span></td>').insertBefore(e.find("tr:eq("+n+") td:first"))})),e.find("td").css("vertical-align","middle"),e.hide(),e},deltaX:15,deltaY:15,delay:o.dragDelay,onBeforeDrag:function(a){var e=c(this);return 0!=o.onBeforeDrag.call(r,e)&&(!t(a.target).parent().hasClass("datagrid-cell-check")&&(1==a.which&&void 0))},onStartDrag:function(){t(this).draggable("proxy").css({left:-1e4,top:-1e4});var a=c(this);v(a,!1),d.draggingRow=a,o.onStartDrag.call(r,a)},onDrag:function(a){var e=a.pageX,n=a.pageY,d=a.data.startX,i=a.data.startY;if(Math.sqrt((e-d)*(e-d)+(n-i)*(n-i))>3){t(this).draggable("proxy").show();var s=o.finder.getTr(r,parseInt(t(this).attr("datagrid-row-index")),"body");t.extend(a.data,{startX:s.offset().left,startY:s.offset().top,offsetWidth:0,offsetHeight:0})}this.pageY=a.pageY},onEndDrag:function(a){var e=t(this).data("draggable").droppables.filter((function(){var e=t(this);if(e.droppable("options").disabled)return!1;if(e.hasClass("datagrid-row")&&!e.hasClass("datagrid-row-over"))return!1;var r=e.offset();return a.pageX>r.left&&a.pageX<r.left+e.outerWidth()&&a.pageY>r.top&&a.pageY<r.top+e.outerHeight()})),r=e.filter((function(){return t(this).hasClass("datagrid-row")}));r.length&&(e=r),t(this).data("draggable").droppables=e},onStopDrag:function(){e(a),a=[],v(d.draggingRow,!0),o.onStopDrag.call(r,d.draggingRow)}},g={disabled:!1,accept:o.dropAccept,onDragEnter:function(e,n){if(!t(this).droppable("options").disabled){var d=u(this),i=t(d).datagrid("options").finder.getTr(d,null,"highlight"),s=c(n),g=p(this);i.length&&g&&0==o.onDragEnter.call(r,g,s)&&(t(d).datagrid("clearInsertingFlag"),i.droppable("disable"),i.each((function(){a.push(this)})))}},onDragOver:function(e,n){if(!(t(this).droppable("options").disabled||t.inArray(this,a)>=0)){var d=u(this),i=t(d).datagrid("options"),s=i.finder.getTr(d,null,"highlight");if(!s.length||h(s)){f(n,!0);var g=c(n),l=p(this);if(s.length){var v=n.pageY,b=s.offset().top,w=s.offset().top+s.outerHeight();t(d).datagrid("clearInsertingFlag"),i.insertingIndex=s.attr("datagrid-row-index"),v>b+(w-b)/2?s.addClass("datagrid-row-bottom"):s.addClass("datagrid-row-top"),l&&0==o.onDragOver.call(r,l,g)&&(f(n,!1),t(d).datagrid("clearInsertingFlag"),s.droppable("disable"),s.each((function(){a.push(this)})))}}else f(n,!1)}},onDragLeave:function(a,e){if(!t(this).droppable("options").disabled){f(e,!1);var n=u(this);t(n).datagrid("clearInsertingFlag");var d=c(e),i=p(this);i&&o.onDragLeave.call(r,i,d)}},onDrop:function(a,e){if(!t(this).droppable("options").disabled){var n=u(e),d=u(this),i=t(d).datagrid("options").finder.getTr(d,null,"highlight"),s=null,g=c(e),l=null;if(i.length){if(!h(i))return;s=i.hasClass("datagrid-row-top")?"top":"bottom",l=p(i)}t(d).datagrid("clearInsertingFlag"),0!=o.onBeforeDrop.call(r,l,g,s)&&(function(){var a=parseInt(i.attr("datagrid-row-index"));if(s)if(d!=n){if((r="top"==s?a:a+1)>=0){l=t(n).datagrid("_getRowIndexs",g);t(d).datagrid("_insertRows",{index:r,row:g}),t(n).datagrid("_deleteRows",l),t(d).datagrid("_setSelections")}}else{var e=t(d);if((r="top"==s?a:a+1)>=0){var r;l=e.datagrid("_getRowIndexs",g),a=parseInt(i.attr("datagrid-row-index"));if((r="top"==s?a:a+1)>=0){e.datagrid("_insertRows",{index:r,row:g});for(var o=0;o<l.length;o++)l[o]>r&&(l[o]+=l.length);e.datagrid("_deleteRows",l),e.datagrid("_setSelections")}}}else{var l=t(n).datagrid("_getRowIndexs",g);t(d).datagrid("_appendRows",g),t(n).datagrid("_deleteRows",l),t(d).datagrid("_setSelections")}}.call(this),o.onDrop.call(r,l,g,s))}}};if(null!=n)var l=o.finder.getTr(this,n);else l=o.finder.getTr(this,0,"allbody");function f(a,e){t(a).draggable("proxy").find("span.tree-dnd-icon").removeClass("tree-dnd-yes tree-dnd-no").addClass(e?"tree-dnd-yes":"tree-dnd-no")}function p(a){if(!t(a).hasClass("datagrid-row"))return null;var e=t(a).closest("div.datagrid-view").children("table,.datagrid-f")[0];return t(e).datagrid("options").finder.getRow(e,t(a))}function c(a){if(!t(a).hasClass("datagrid-row"))return null;for(var e=u(a),r=t(e).datagrid("options"),n=t(e).datagrid("getRows"),d=0;d<n.length;d++)n[d]._selected=void 0;if(r.dragSelection&&t(a).hasClass("datagrid-row-selected")){n=t(e).datagrid("getSelections");return t.map(n,(function(t){t._selected=!0})),n}var i=r.finder.getRow(e,t(a));return i._selected=t(a).hasClass("datagrid-row-selected"),i}function u(a){return t(a).closest("div.datagrid-view").children("table,.datagrid-f")[0]}function h(a){var e=t(a).droppable("options");return!e.disabled&&"no-accept"!=e.accept}function v(a,e){var n=e?o.dropAccept:"no-accept";t.map(t.isArray(a)?a:[a],(function(a){var e=t(r).datagrid("getRowIndex",a);o.finder.getTr(r,e).droppable({accept:n})}))}l.draggable(s),l.droppable(g),function(a){(function(a){var e=t(a).data("datagrid").dc;return e.view})(a).droppable(g).droppable("enable")}(r)}))},disableDnd:function(a){return a.each((function(){var a=t.data(this,"datagrid"),e=(t(this),a.options.finder.getTr(this,0,"allbody"));e.draggable("disable"),e.droppable("disable")}))}})}(jQuery);