/* Copyright (C) 2023 by WorkerBot.AI */
!function(e){function t(t){var r=e.data(t,"combotreegrid"),o=r.options,n=r.grid,d=[];if(o.multiple)d=e.map(n.treegrid("getCheckedNodes"),(function(e){return e[o.idField]}));else{var a=n.treegrid("getSelected");a&&d.push(a[o.idField])}i(t,d=d.concat(o.unselectedValues))}function i(t,i){var r=e.data(t,"combotreegrid"),o=r.options,n=r.grid,d=n.datagrid("options"),a=d.onBeforeCheck,c=d.onCheck,l=d.onBeforeSelect,s=d.onSelect;d.onBeforeCheck=d.onCheck=d.onBeforeSelect=d.onSelect=function(){},e.isArray(i)||(i=i.split(o.separator)),o.multiple||(i=i.length?[i[0]]:[""]);var u=e.map(i,(function(e){return String(e)}));u=e.grep(u,(function(t,i){return i===e.inArray(t,u)}));var g=n.treegrid("getSelected");g&&n.treegrid("unselect",g[o.idField]),e.map(n.treegrid("getCheckedNodes"),(function(t){-1==e.inArray(String(t[o.idField]),u)&&n.treegrid("uncheckNode",t[o.idField])}));var h=[];if(o.unselectedValues=[],e.map(u,(function(t){var i,r,d,a=n.treegrid("find",t);a?(o.multiple?n.treegrid("checkNode",t):n.treegrid("select",t),h.push(m(a))):(h.push((i=t,r=o.mappingRows,((d=e.easyui.getArrayItem(r,o.idField,i))?m(d):void 0)||t)),o.unselectedValues.push(t))})),o.multiple&&e.map(n.treegrid("getCheckedNodes"),(function(t){var i=String(t[o.idField]);-1==e.inArray(i,u)&&(u.push(i),h.push(m(t)))})),d.onBeforeCheck=a,d.onCheck=c,d.onBeforeSelect=l,d.onSelect=s,!r.remainText){var f=h.join(o.separator);e(t).combo("getText")!=f&&e(t).combo("setText",f)}function m(e){return e[o.textField||""]||e[o.treeField]}e(t).combo("setValues",u)}function r(t){var i=e.data(t,"combotreegrid"),r=i.options,o=i.grid,n=r.finder.getTr(o[0],null,"highlight");if(i.remainText=!1,n.length){var d=n.attr("node-id");r.multiple?n.hasClass("datagrid-row-selected")?o.treegrid("uncheckNode",d):o.treegrid("checkNode",d):o.treegrid("selectRow",d)}var a=[];if(r.multiple)e.map(o.treegrid("getCheckedNodes"),(function(e){a.push(e[r.idField])}));else{var c=o.treegrid("getSelected");c&&a.push(c[r.idField])}e.map(r.unselectedValues,(function(t){e.easyui.indexOfArray(r.mappingRows,r.idField,t)>=0&&e.easyui.addArrayItem(a,t)})),e(t).combotreegrid("setValues",a),r.multiple||e(t).combotreegrid("hidePanel")}e.fn.combotreegrid=function(r,o){if("string"==typeof r){var n=e.fn.combotreegrid.methods[r];return n?n(this,o):this.combo(r,o)}return r=r||{},this.each((function(){var o=e.data(this,"combotreegrid");o?e.extend(o.options,r):o=e.data(this,"combotreegrid",{options:e.extend({},e.fn.combotreegrid.defaults,e.fn.combotreegrid.parseOptions(this),r)}),function(r){var o=e.data(r,"combotreegrid"),n=o.options;if(e(r).addClass("combotreegrid-f").combo(e.extend({},n,{onShowPanel:function(){var t=e(this).combotreegrid("panel"),i=t.outerHeight()-t.height(),r=t._size("minHeight"),o=t._size("maxHeight"),d=e(this).combotreegrid("grid");d.treegrid("resize",{width:"100%",height:isNaN(parseInt(n.panelHeight))?"auto":"100%",minHeight:r?r-i:"",maxHeight:o?o-i:""});var a=d.treegrid("getSelected");a&&d.treegrid("scrollTo",a[n.idField]),n.onShowPanel.call(this)}})),!o.grid){var d=e(r).combo("panel");o.grid=e("<table></table>").appendTo(d)}o.grid.treegrid(e.extend({},n,{border:!1,checkbox:n.multiple,onLoadSuccess:function(t,d){var a=e(r).combotreegrid("getValues");n.multiple&&e.map(e(this).treegrid("getCheckedNodes"),(function(t){e.easyui.addArrayItem(a,t[n.idField])})),i(r,a),n.onLoadSuccess.call(this,t,d),o.remainText=!1},onClickRow:function(i){n.multiple?(e(this).treegrid(i.checked?"uncheckNode":"checkNode",i[n.idField]),e(this).treegrid("unselect",i[n.idField])):e(r).combo("hidePanel"),t(r),n.onClickRow.call(this,i)},onCheckNode:function(e,i){t(r),n.onCheckNode.call(this,e,i)}}))}(this)}))},e.fn.combotreegrid.methods={options:function(t){var i=t.combo("options");return e.extend(e.data(t[0],"combotreegrid").options,{width:i.width,height:i.height,originalValue:i.originalValue,disabled:i.disabled,readonly:i.readonly,editable:i.editable})},grid:function(t){return e.data(t[0],"combotreegrid").grid},setValues:function(t,r){return t.each((function(){var t=e(this).combotreegrid("options");e.isArray(r)&&(r=e.map(r,(function(i){return i&&"object"==typeof i?(e.easyui.addArrayItem(t.mappingRows,t.idField,i),i[t.idField]):i}))),i(this,r)}))},setValue:function(t,i){return t.each((function(){e(this).combotreegrid("setValues",e.isArray(i)?i:[i])}))},clear:function(t){return t.each((function(){e(this).combotreegrid("setValues",[])}))},reset:function(t){return t.each((function(){var t=e(this).combotreegrid("options");t.multiple?e(this).combotreegrid("setValues",t.originalValue):e(this).combotreegrid("setValue",t.originalValue)}))}},e.fn.combotreegrid.parseOptions=function(t){e(t);return e.extend({},e.fn.combo.parseOptions(t),e.fn.treegrid.parseOptions(t),e.parser.parseOptions(t,["mode",{limitToGrid:"boolean"}]))},e.fn.combotreegrid.defaults=e.extend({},e.fn.combo.defaults,e.fn.treegrid.defaults,{editable:!1,singleSelect:!0,limitToGrid:!1,unselectedValues:[],mappingRows:[],mode:"local",textField:null,keyHandler:{up:function(e){},down:function(e){},left:function(e){},right:function(e){},enter:function(e){r(this)},query:function(t,i){!function(t,i){var r=e.data(t,"combotreegrid"),o=r.options,n=r.grid;r.remainText=!0;var d=o.multiple?i.split(o.separator):[i];if(d=e.grep(d,(function(t){return""!=e.trim(t)})),n.treegrid("clearSelections").treegrid("clearChecked").treegrid("highlightRow",-1),"remote"==o.mode)l(d),n.treegrid("load",e.extend({},o.queryParams,{q:i}));else if(i){var a=n.treegrid("getData"),c=[];e.map(d,(function(i){if(i=e.trim(i)){var r=void 0;e.easyui.forEach(a,!0,(function(e){return i.toLowerCase()==String(e[o.treeField]).toLowerCase()?(r=e[o.idField],!1):o.filter.call(t,i,e)?(n.treegrid("expandTo",e[o.idField]),n.treegrid("highlightRow",e[o.idField]),!1):void 0})),null==r&&e.easyui.forEach(o.mappingRows,!1,(function(e){if(i.toLowerCase()==String(e[o.treeField]))return r=e[o.idField],!1})),null!=r?c.push(r):c.push(i)}})),l(c),r.remainText=!1}function l(i){o.reversed||e(t).combotreegrid("setValues",i)}}(this,t)}},inputEvents:e.extend({},e.fn.combo.defaults.inputEvents,{blur:function(t){e.fn.combo.defaults.inputEvents.blur(t);var i=t.data.target;e(i).combotreegrid("options").limitToGrid&&r(i)}}),filter:function(t,i){return(i[e(this).combotreegrid("options").treeField]||"").toLowerCase().indexOf(t.toLowerCase())>=0}})}(jQuery);