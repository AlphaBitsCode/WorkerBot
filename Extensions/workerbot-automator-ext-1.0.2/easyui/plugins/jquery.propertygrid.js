/* Copyright (C) 2023 by WorkerBot.AI */
!function(r){var t;function e(t){var e=r(t);if(e.length){var a=r.data(t,"propertygrid").options;a.finder.getTr(t,null,"editing").each((function(){var t=parseInt(r(this).attr("datagrid-row-index"));e.datagrid("validateRow",t)?e.datagrid("endEdit",t):e.datagrid("cancelEdit",t)})),a.editIndex=void 0}}r(document)._unbind(".propertygrid")._bind("mousedown.propertygrid",(function(a){r(a.target).closest("div.datagrid-view,div.combo-panel").length||(e(t),t=void 0)})),r.fn.propertygrid=function(a,d){if("string"==typeof a){var i=r.fn.propertygrid.methods[a];return i?i(this,d):this.datagrid(a,d)}return a=a||{},this.each((function(){var d=r.data(this,"propertygrid");if(d)r.extend(d.options,a);else{var i=r.extend({},r.fn.propertygrid.defaults,r.fn.propertygrid.parseOptions(this),a);i.frozenColumns=r.extend(!0,[],i.frozenColumns),i.columns=r.extend(!0,[],i.columns),r.data(this,"propertygrid",{options:i})}!function(a){r.data(a,"propertygrid");var d=r.data(a,"propertygrid").options;r(a).datagrid(r.extend({},d,{cls:"propertygrid",view:d.showGroup?d.groupView:d.view,onBeforeEdit:function(t,e){if(0==d.onBeforeEdit.call(a,t,e))return!1;var i=r(this);e=i.datagrid("getRows")[t],i.datagrid("getColumnOption","value").editor=e.editor},onClickCell:function(i,o,n){if(t!=this&&(e(t),t=this),d.editIndex!=i){e(t),r(this).datagrid("beginEdit",i);var s=r(this).datagrid("getEditor",{index:i,field:o});if(s||(s=r(this).datagrid("getEditor",{index:i,field:"value"})),s){var l=r(s.target);(l.data("textbox")?l.textbox("textbox"):l).focus(),d.editIndex=i}}d.onClickCell.call(a,i,o,n)},loadFilter:function(r){return e(this),d.loadFilter.call(this,r)}}))}(this)}))},r.fn.propertygrid.methods={options:function(t){return r.data(t[0],"propertygrid").options}},r.fn.propertygrid.parseOptions=function(t){return r.extend({},r.fn.datagrid.parseOptions(t),r.parser.parseOptions(t,[{showGroup:"boolean"}]))};var a=r.extend({},r.fn.datagrid.defaults.view,{render:function(t,e,a){for(var d=[],i=this.groups,o=0;o<i.length;o++)d.push(this.renderGroup.call(this,t,o,i[o],a));r(e).html(d.join(""))},renderGroup:function(t,e,a,d){var i=r.data(t,"datagrid"),o=i.options,n=r(t).datagrid("getColumnFields",d),s=o.frozenColumns&&o.frozenColumns.length;if(d&&!o.rownumbers&&!s)return"";var l=[],p=function(r,t){var e="",a="";"string"==typeof r?a=r:r&&(e=r.class||"",a=r.style||"");return'class="'+t+(e?" "+e:"")+'" style="'+a+'"'}(h=o.groupStyler.call(t,a.value,a.rows),"datagrid-group");l.push("<div group-index="+e+" "+p+">"),(d&&(o.rownumbers||o.frozenColumns.length)||!d&&!o.rownumbers&&!o.frozenColumns.length)&&(l.push('<span class="datagrid-group-expander">'),l.push('<span class="datagrid-row-expander datagrid-row-collapse">&nbsp;</span>'),l.push("</span>")),(d&&s||!d)&&(l.push('<span class="datagrid-group-title">'),l.push(o.groupFormatter.call(t,a.value,a.rows)),l.push("</span>")),l.push("</div>"),l.push('<table class="datagrid-btable" cellspacing="0" cellpadding="0" border="0"><tbody>');for(var g=a.startIndex,u=0;u<a.rows.length;u++){var h,c="",f="";"string"==typeof(h=o.rowStyler?o.rowStyler.call(t,g,a.rows[u]):"")?f=h:h&&(c=h.class||"",f=h.style||"");var v='class="datagrid-row '+(g%2&&o.striped?"datagrid-row-alt ":" ")+c+'"',w=f?'style="'+f+'"':"",x=i.rowIdPrefix+"-"+(d?1:2)+"-"+g;l.push('<tr id="'+x+'" datagrid-row-index="'+g+'" '+v+" "+w+">"),l.push(this.renderRow.call(this,t,n,d,g,a.rows[u])),l.push("</tr>"),g++}return l.push("</tbody></table>"),l.join("")},bindEvents:function(t){var e=r.data(t,"datagrid").dc,a=e.body1.add(e.body2),d=(r.data(a[0],"events")||r._data(a[0],"events")).click[0].handler;a._unbind("click")._bind("click",(function(e){var a=r(e.target).closest("span.datagrid-row-expander");if(a.length){var i=a.closest("div.datagrid-group").attr("group-index");a.hasClass("datagrid-row-collapse")?r(t).datagrid("collapseGroup",i):r(t).datagrid("expandGroup",i)}else d(e);e.stopPropagation()}))},onBeforeRender:function(t,e){var a=r.data(t,"datagrid"),d=a.options;r("#datagrid-group-style").length||r("head").append('<style id="datagrid-group-style">.datagrid-group{height:'+d.groupHeight+"px;overflow:hidden;font-weight:bold;border-bottom:1px solid #ccc;white-space:nowrap;word-break:normal;}.datagrid-group-title,.datagrid-group-expander{display:inline-block;vertical-align:bottom;height:100%;line-height:"+d.groupHeight+"px;padding:0 4px;}.datagrid-group-title{position:relative;}.datagrid-group-expander{width:"+d.expanderWidth+"px;text-align:center;padding:0}.datagrid-group-expander .datagrid-row-expander{margin:"+Math.floor((d.groupHeight-16)/2)+"px 0;display:inline-block;width:16px;height:16px;cursor:pointer}</style>");for(var i=[],o=0;o<e.length;o++){var n=e[o];(p=u(n[d.groupField]))?p.rows.push(n):(p={value:n[d.groupField],rows:[n]},i.push(p))}var s=0,l=[];for(o=0;o<i.length;o++){var p;(p=i[o]).startIndex=s,s+=p.rows.length,l=l.concat(p.rows)}a.data.rows=l,this.groups=i;var g=this;function u(r){for(var t=0;t<i.length;t++){var e=i[t];if(e.value==r)return e}return null}setTimeout((function(){g.bindEvents(t)}),0)},onAfterRender:function(t){r.fn.datagrid.defaults.view.onAfterRender.call(this,t);var e=this,a=r.data(t,"datagrid"),d=a.options;a.onResizeColumn||(a.onResizeColumn=d.onResizeColumn),a.onResize||(a.onResize=d.onResize),d.onResizeColumn=function(r,d){e.resizeGroup(t),a.onResizeColumn.call(t,r,d)},d.onResize=function(d,i){e.resizeGroup(t),a.onResize.call(r(t).datagrid("getPanel")[0],d,i)},e.resizeGroup(t)}});r.extend(r.fn.datagrid.methods,{groups:function(r){return r.datagrid("options").view.groups},expandGroup:function(t,e){return t.each((function(){var t=r(this).datagrid("options"),a=r.data(this,"datagrid").dc.view.find(null!=e?'div.datagrid-group[group-index="'+e+'"]':"div.datagrid-group"),d=a.find("span.datagrid-row-expander");d.hasClass("datagrid-row-expand")&&(d.removeClass("datagrid-row-expand").addClass("datagrid-row-collapse"),a.next("table").show()),r(this).datagrid("fixRowHeight"),t.onExpandGroup&&t.onExpandGroup.call(this,e)}))},collapseGroup:function(t,e){return t.each((function(){var t=r(this).datagrid("options"),a=r.data(this,"datagrid").dc.view.find(null!=e?'div.datagrid-group[group-index="'+e+'"]':"div.datagrid-group"),d=a.find("span.datagrid-row-expander");d.hasClass("datagrid-row-collapse")&&(d.removeClass("datagrid-row-collapse").addClass("datagrid-row-expand"),a.next("table").hide()),r(this).datagrid("fixRowHeight"),t.onCollapseGroup&&t.onCollapseGroup.call(this,e)}))},scrollToGroup:function(t,e){return t.each((function(){var t=r.data(this,"datagrid").dc,a=t.body2.children('div.datagrid-group[group-index="'+e+'"]');if(a.length){var d=a.outerHeight(),i=t.view2.children("div.datagrid-header")._outerHeight(),o=t.body2.outerHeight(!0)-t.body2.outerHeight(),n=a.position().top-i-o;n<0?t.body2.scrollTop(t.body2.scrollTop()+n):n+d>t.body2.height()-18&&t.body2.scrollTop(t.body2.scrollTop()+n+d-t.body2.height()+18)}}))}}),r.extend(a,{refreshGroupTitle:function(t,e){var a=r.data(t,"datagrid"),d=a.options,i=a.dc,o=this.groups[e];i.body1.add(i.body2).children("div.datagrid-group[group-index="+e+"]").find("span.datagrid-group-title").html(d.groupFormatter.call(t,o.value,o.rows))},resizeGroup:function(t,e){var a=r.data(t,"datagrid"),d=a.dc,i=d.header2.find("table").find("tr.datagrid-filter-row").hide(),o=d.body2.children("table.datagrid-btable:first").width();if(null==e)var n=d.body2.children("div.datagrid-group");else n=d.body2.children("div.datagrid-group[group-index="+e+"]");n._outerWidth(o);var s=a.options;if(s.frozenColumns&&s.frozenColumns.length){var l=d.view1.width()-s.expanderWidth,p="rtl"==d.view1.css("direction").toLowerCase();n.find(".datagrid-group-title").css(p?"right":"left",-l+"px")}i.length&&s.showFilterBar&&i.show()},insertRow:function(t,e,a){var d,i=r.data(t,"datagrid"),o=i.options,n=i.dc,s=null;if(i.data.rows.length){for(var l=0;l<this.groups.length;l++)if(this.groups[l].value==a[o.groupField]){s=this.groups[l],d=l;break}s?(null!=e&&null!=e||(e=i.data.rows.length),e<s.startIndex?e=s.startIndex:e>s.startIndex+s.rows.length&&(e=s.startIndex+s.rows.length),r.fn.datagrid.defaults.view.insertRow.call(this,t,e,a),e>=s.startIndex+s.rows.length&&(p(e,!0),p(e,!1)),s.rows.splice(e-s.startIndex,0,a)):(s={value:a[o.groupField],rows:[a],startIndex:i.data.rows.length},d=this.groups.length,n.body1.append(this.renderGroup.call(this,t,d,s,!0)),n.body2.append(this.renderGroup.call(this,t,d,s,!1)),this.groups.push(s),i.data.rows.push(a)),this.setGroupIndex(t),this.refreshGroupTitle(t,d),this.resizeGroup(t)}else r(t).datagrid("loadData",[a]);function p(r,e){var a=e?1:2,d=o.finder.getTr(t,r-1,"body",a);o.finder.getTr(t,r,"body",a).insertAfter(d)}},updateRow:function(t,e,a){var d=r.data(t,"datagrid").options;r.fn.datagrid.defaults.view.updateRow.call(this,t,e,a);var i=d.finder.getTr(t,e,"body",2).closest("table.datagrid-btable"),o=parseInt(i.prev().attr("group-index"));this.refreshGroupTitle(t,o)},deleteRow:function(t,e){var a=r.data(t,"datagrid"),d=a.options,i=a.dc,o=i.body1.add(i.body2),n=d.finder.getTr(t,e,"body",2).closest("table.datagrid-btable"),s=parseInt(n.prev().attr("group-index"));r.fn.datagrid.defaults.view.deleteRow.call(this,t,e);var l=this.groups[s];if(l.rows.length>1)l.rows.splice(e-l.startIndex,1),this.refreshGroupTitle(t,s);else{o.children("div.datagrid-group[group-index="+s+"]").remove();for(var p=s+1;p<this.groups.length;p++)o.children("div.datagrid-group[group-index="+p+"]").attr("group-index",p-1);this.groups.splice(s,1)}this.setGroupIndex(t)},setGroupIndex:function(r){for(var t=0,e=0;e<this.groups.length;e++){var a=this.groups[e];a.startIndex=t,t+=a.rows.length}}}),r.fn.propertygrid.defaults=r.extend({},r.fn.datagrid.defaults,{groupHeight:28,expanderWidth:20,singleSelect:!0,remoteSort:!1,fitColumns:!0,loadMsg:"",frozenColumns:[[{field:"f",width:20,resizable:!1}]],columns:[[{field:"name",title:"Name",width:100,sortable:!0},{field:"value",title:"Value",width:100,resizable:!1}]],showGroup:!1,groupView:a,groupField:"group",groupStyler:function(r,t){return""},groupFormatter:function(r,t){return r}})}(jQuery);