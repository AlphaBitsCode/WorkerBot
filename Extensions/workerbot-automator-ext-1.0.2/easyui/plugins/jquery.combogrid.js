/* Copyright (C) 2023 by WorkerBot.AI */
!function(e){function t(t,i){var o=e.data(t,"combogrid"),n=o.options,a=o.grid,r=a.datagrid("getRows").length;if(r){var d=n.finder.getTr(a[0],null,"highlight");if(d.length||(d=n.finder.getTr(a[0],null,"selected")),d.length){var l=parseInt(d.attr("datagrid-row-index"));(l+="next"==i?1:-1)<0&&(l=r-1),l>=r&&(l=0)}else l="next"==i?0:r-1;a.datagrid("highlightRow",l),n.selectOnNavigation&&(o.remainText=!1,a.datagrid("selectRow",l))}}function i(t,i,o){var n=e.data(t,"combogrid"),a=n.options,r=n.grid,d=e(t).combo("getValues"),l=e(t).combo("options"),s=l.onChange;l.onChange=function(){};var c=r.datagrid("options"),g=c.onSelect,u=c.onUnselect,m=c.onUnselectAll;c.onSelect=c.onUnselect=c.onUnselectAll=function(){},e.isArray(i)||(i=i.split(a.separator)),a.multiple||(i=i.length?[i[0]]:[""]);var h=e.map(i,(function(e){return String(e)}));h=e.grep(h,(function(t,i){return i===e.inArray(t,h)}));var p=e.grep(r.datagrid("getSelections"),(function(t,i){return e.inArray(String(t[a.idField]),h)>=0}));r.datagrid("clearSelections"),r.data("datagrid").selectedRows=p;var f=[];if(a.unselectedValues=[],e.map(h,(function(t){var i=r.datagrid("getRowIndex",t);i>=0?r.datagrid("selectRow",i):-1==e.easyui.indexOfArray(p,a.idField,t)&&a.unselectedValues.push(t),f.push(v(t,r.datagrid("getRows"))||v(t,p)||v(t,a.mappingRows)||t)})),e(t).combo("setValues",d),l.onChange=s,c.onSelect=g,c.onUnselect=u,c.onUnselectAll=m,!o){var b=f.join(a.separator);e(t).combo("getText")!=b&&e(t).combo("setText",b)}function v(t,i){var o=e.easyui.getArrayItem(i,a.idField,t);return o?o[a.textField]:void 0}e(t).combo("setValues",i)}e.fn.combogrid=function(t,o){if("string"==typeof t){var n=e.fn.combogrid.methods[t];return n?n(this,o):this.combo(t,o)}return t=t||{},this.each((function(){var o=e.data(this,"combogrid");o?e.extend(o.options,t):o=e.data(this,"combogrid",{options:e.extend({},e.fn.combogrid.defaults,e.fn.combogrid.parseOptions(this),t)}),function(t){var o=e.data(t,"combogrid"),n=o.options,a=o.grid;e(t).addClass("combogrid-f").combo(e.extend({},n,{onShowPanel:function(){i(this,e(this).combogrid("getValues"),!0);var t=e(this).combogrid("panel"),o=t.outerHeight()-t.height(),a=t._size("minHeight"),r=t._size("maxHeight"),d=e(this).combogrid("grid");d.datagrid("resize",{width:"100%",height:isNaN(parseInt(n.panelHeight))?"auto":"100%",minHeight:a?a-o:"",maxHeight:r?r-o:""});var l=d.datagrid("getSelected");l&&d.datagrid("scrollTo",d.datagrid("getRowIndex",l)),n.onShowPanel.call(this)}}));var r=e(t).combo("panel");function d(i){return e(i).closest(".combo-panel").panel("options").comboTarget||t}function l(t){return function(i,o){var n=d(this),a=e(n).combogrid("options");"onUnselectAll"==t?a.multiple&&s.call(this):s.call(this),a[t].call(this,i,o)}}function s(){var t=e(this),o=d(t),n=e(o).data("combogrid"),a=n.options,r=e.map(t.datagrid("getSelections"),(function(e){return e[a.idField]}));r=r.concat(a.unselectedValues);var l=t.data("datagrid").dc.body2,s=l.scrollTop();i(o,r,n.remainText),l.scrollTop(s)}a||(a=e("<table></table>").appendTo(r),o.grid=a),a.datagrid(e.extend({},n,{border:!1,singleSelect:!n.multiple,onLoadSuccess:function(t){var o=d(this),n=e(o).data("combogrid"),a=n.options;i(o,e(o).combo("getValues"),n.remainText),a.onLoadSuccess.call(this,t)},onClickRow:function(t,i){var o=d(this),n=e(o).data("combogrid"),a=n.options;n.remainText=!1,s.call(this),a.multiple||e(o).combo("hidePanel"),a.onClickRow.call(this,t,i)},onSelect:l("onSelect"),onUnselect:l("onUnselect"),onSelectAll:l("onSelectAll"),onUnselectAll:l("onUnselectAll")}))}(this)}))},e.fn.combogrid.methods={options:function(t){var i=t.combo("options");return e.extend(e.data(t[0],"combogrid").options,{width:i.width,height:i.height,originalValue:i.originalValue,disabled:i.disabled,readonly:i.readonly,editable:i.editable})},cloneFrom:function(t,i){return t.each((function(){e(this).combo("cloneFrom",i),e.data(this,"combogrid",{options:e.extend(!0,{cloned:!0},e(i).combogrid("options")),combo:e(this).next(),panel:e(i).combo("panel"),grid:e(i).combogrid("grid")})}))},grid:function(t){return e.data(t[0],"combogrid").grid},setValues:function(t,o){return t.each((function(){var t=e(this).combogrid("options");e.isArray(o)&&(o=e.map(o,(function(i){return i&&"object"==typeof i?(e.easyui.addArrayItem(t.mappingRows,t.idField,i),i[t.idField]):i}))),i(this,o)}))},setValue:function(t,i){return t.each((function(){e(this).combogrid("setValues",e.isArray(i)?i:[i])}))},clear:function(t){return t.each((function(){e(this).combogrid("setValues",[])}))},reset:function(t){return t.each((function(){var t=e(this).combogrid("options");t.multiple?e(this).combogrid("setValues",t.originalValue):e(this).combogrid("setValue",t.originalValue)}))}},e.fn.combogrid.parseOptions=function(t){e(t);return e.extend({},e.fn.combo.parseOptions(t),e.fn.datagrid.parseOptions(t),e.parser.parseOptions(t,["idField","textField","mode"]))},e.fn.combogrid.defaults=e.extend({},e.fn.combo.defaults,e.fn.datagrid.defaults,{loadMsg:null,idField:null,textField:null,unselectedValues:[],mappingRows:[],mode:"local",keyHandler:{up:function(e){t(this,"prev"),e.preventDefault()},down:function(e){t(this,"next"),e.preventDefault()},left:function(e){},right:function(e){},enter:function(t){!function(t){var i=e.data(t,"combogrid"),o=i.options,n=i.grid,a=o.finder.getTr(n[0],null,"highlight");if(i.remainText=!1,a.length){var r=parseInt(a.attr("datagrid-row-index"));o.multiple&&a.hasClass("datagrid-row-selected")?n.datagrid("unselectRow",r):n.datagrid("selectRow",r)}var d=[];e.map(n.datagrid("getSelections"),(function(e){d.push(e[o.idField])})),e.map(o.unselectedValues,(function(t){e.easyui.indexOfArray(o.mappingRows,o.idField,t)>=0&&e.easyui.addArrayItem(d,t)})),e(t).combogrid("setValues",d),o.multiple||e(t).combogrid("hidePanel")}(this)},query:function(t,o){!function(t,o){var n=e.data(t,"combogrid"),a=n.options,r=n.grid;n.remainText=!0;var d=a.multiple?o.split(a.separator):[o];if(d=e.grep(d,(function(t){return""!=e.trim(t)})),"remote"==a.mode)g(d),r.datagrid("load",e.extend({},a.queryParams,{q:o}));else{r.datagrid("highlightRow",-1);var l=r.datagrid("getRows"),s=[];e.map(d,(function(i){i=e.trim(i),c(a.mappingRows,i),c(r.datagrid("getSelections"),i);var o=c(l,i);o>=0?a.reversed&&r.datagrid("highlightRow",o):e.map(l,(function(e,o){a.filter.call(t,i,e)&&r.datagrid("highlightRow",o)}))})),g(s)}function c(e,t){for(var i=0;i<e.length;i++){var o=e[i];if((o[a.textField]||"").toLowerCase()==t.toLowerCase())return s.push(o[a.idField]),i}return-1}function g(e){a.reversed||i(t,e,!0)}}(this,t)}},inputEvents:e.extend({},e.fn.combo.defaults.inputEvents,{blur:function(t){e.fn.combo.defaults.inputEvents.blur(t);var i=t.data.target;e(i).combogrid("options").reversed&&e(i).combogrid("setValues",e(i).combogrid("getValues"))}}),panelEvents:{mousedown:function(e){}},filter:function(t,i){return(i[e(this).combogrid("options").textField]||"").toLowerCase().indexOf(t.toLowerCase())>=0}})}(jQuery);